<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件传输工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        dark: '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .card {
                @apply bg-white rounded-lg shadow-md p-6 transition-all hover:shadow-lg;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-dark mb-2">
                <i class="fa fa-github mr-2"></i>文件传输工具
            </h1>
            <p class="text-secondary text-lg">简单高效的跨设备文件传输解决方案</p>
        </header>

        <!-- 模式选择器 -->
        <div class="card mb-8">
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="mode-create" class="btn-primary flex-1">
                    <i class="fa fa-plus-circle mr-2"></i>创建新存储
                </button>
                <button id="mode-access" class="btn-secondary flex-1">
                    <i class="fa fa-key mr-2"></i>访问现有存储
                </button>
            </div>
        </div>

        <!-- 创建新存储 -->
        <div id="create-section" class="card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-plus-circle text-primary mr-2"></i>创建新存储
            </h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="github-token">GitHub 令牌</label>
                <input 
                    type="password" 
                    id="github-token" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                    placeholder="输入你的GitHub令牌"
                >
                <p class="text-xs text-gray-500 mt-1">需要具备repo权限的个人访问令牌</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="repo-name">存储仓库名</label>
                <input 
                    type="text" 
                    id="repo-name" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                    placeholder="例如：my-file-storage"
                >
            </div>
            
            <button id="create-storage" class="btn-primary w-full">
                <i class="fa fa-check mr-2"></i>创建存储
            </button>
            
            <div id="create-result" class="mt-4 hidden">
                <div class="p-3 bg-green-100 border border-green-400 rounded text-green-700">
                    <h3 class="font-medium mb-1">存储创建成功！</h3>
                    <p>存储ID: <span id="storage-id" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
                    <p>访问代码: <span id="access-code" class="font-mono bg-gray-200 px-2 py-1 rounded text-lg font-bold"></span></p>
                    <p class="text-sm mt-2">请记录以上信息用于在其他设备访问</p>
                </div>
            </div>
        </div>

        <!-- 访问现有存储 -->
        <div id="access-section" class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-key text-primary mr-2"></i>访问存储
            </h2>
            
            <div class="mb-4">
                <div class="flex items-center mb-1">
                    <label class="block text-sm font-medium text-gray-700">访问方式</label>
                </div>
                <div class="flex gap-2">
                    <button id="access-code-btn" class="btn-primary flex-1">6位访问码</button>
                    <button id="full-id-btn" class="btn-secondary flex-1">完整存储ID</button>
                </div>
            </div>
            
            <!-- 6位访问码方式 -->
            <div id="code-access" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="short-code">6位访问码</label>
                    <input 
                        type="text" 
                        id="short-code" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus text-center text-xl"
                        placeholder="输入6位代码"
                        maxlength="6"
                    >
                </div>
                
                <button id="access-with-code" class="btn-primary w-full">
                    <i class="fa fa-unlock mr-2"></i>使用访问码访问
                </button>
            </div>
            
            <!-- 完整ID方式 -->
            <div id="full-access" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="full-storage-id">存储ID</label>
                    <input 
                        type="text" 
                        id="full-storage-id" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                        placeholder="输入完整存储ID"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="access-token">访问令牌</label>
                    <input 
                        type="password" 
                        id="access-token" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                        placeholder="输入令牌"
                    >
                </div>
                
                <button id="access-with-full" class="btn-primary w-full">
                    <i class="fa fa-unlock-alt mr-2"></i>使用完整信息访问
                </button>
            </div>
        </div>

        <!-- 文件操作区域 -->
        <div id="file-operation" class="card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-folder-open text-primary mr-2"></i>存储内容
                <span id="storage-info" class="ml-2 text-sm text-gray-500"></span>
            </h2>
            
            <div class="mb-6">
                <button id="upload-btn" class="btn-secondary mb-4">
                    <i class="fa fa-upload mr-2"></i>上传文件
                </button>
                <input type="file" id="file-upload" class="hidden" multiple>
                
                <div class="relative">
                    <div id="upload-progress" class="hidden absolute top-0 left-0 h-full bg-primary/20 rounded-md transition-all" style="width: 0%"></div>
                    <div id="upload-status" class="hidden text-center py-2 relative z-10"></div>
                </div>
            </div>
            
            <div class="mb-4">
                <h3 class="font-medium mb-2">文件列表</h3>
                <div id="file-list" class="border rounded-md max-h-60 overflow-y-auto divide-y">
                    <div class="p-4 text-center text-gray-500">
                        连接后将显示文件列表
                    </div>
                </div>
            </div>
        </div>

        <!-- 消息提示 -->
        <div id="message" class="fixed bottom-4 right-4 p-4 rounded-md shadow-lg transform transition-all duration-300 translate-y-20 opacity-0 max-w-xs"></div>
    </div>

    <script>
        // DOM元素
        const modeCreateBtn = document.getElementById('mode-create');
        const modeAccessBtn = document.getElementById('mode-access');
        const createSection = document.getElementById('create-section');
        const accessSection = document.getElementById('access-section');
        const fileOperation = document.getElementById('file-operation');
        const accessCodeBtn = document.getElementById('access-code-btn');
        const fullIdBtn = document.getElementById('full-id-btn');
        const codeAccess = document.getElementById('code-access');
        const fullAccess = document.getElementById('full-access');
        
        // 状态变量
        let currentStorage = null;
        let currentToken = null;
        
        // 模式切换
        modeCreateBtn.addEventListener('click', () => {
            createSection.classList.remove('hidden');
            accessSection.classList.add('hidden');
            fileOperation.classList.add('hidden');
            modeCreateBtn.classList.remove('btn-secondary');
            modeCreateBtn.classList.add('btn-primary');
            modeAccessBtn.classList.remove('btn-primary');
            modeAccessBtn.classList.add('btn-secondary');
        });
        
        modeAccessBtn.addEventListener('click', () => {
            createSection.classList.add('hidden');
            accessSection.classList.remove('hidden');
            fileOperation.classList.add('hidden');
            modeCreateBtn.classList.remove('btn-primary');
            modeCreateBtn.classList.add('btn-secondary');
            modeAccessBtn.classList.remove('btn-secondary');
            modeAccessBtn.classList.add('btn-primary');
        });
        
        // 访问方式切换
        accessCodeBtn.addEventListener('click', () => {
            codeAccess.classList.remove('hidden');
            fullAccess.classList.add('hidden');
            accessCodeBtn.classList.remove('btn-secondary');
            accessCodeBtn.classList.add('btn-primary');
            fullIdBtn.classList.remove('btn-primary');
            fullIdBtn.classList.add('btn-secondary');
        });
        
        fullIdBtn.addEventListener('click', () => {
            codeAccess.classList.add('hidden');
            fullAccess.classList.remove('hidden');
            accessCodeBtn.classList.remove('btn-primary');
            accessCodeBtn.classList.add('btn-secondary');
            fullIdBtn.classList.remove('btn-secondary');
            fullIdBtn.classList.add('btn-primary');
        });
        
        // 上传按钮点击事件
        document.getElementById('upload-btn').addEventListener('click', () => {
            document.getElementById('file-upload').click();
        });
        
        // 文件选择处理
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length > 0 && currentStorage && currentToken) {
                await uploadFiles(files);
            }
        });
        
        // 创建存储
        document.getElementById('create-storage').addEventListener('click', async () => {
            const token = document.getElementById('github-token').value.trim();
            const repoName = document.getElementById('repo-name').value.trim();
            
            if (!token || !repoName) {
                showMessage('请填写所有字段', 'error');
                return;
            }
            
            try {
                showMessage('正在创建存储...', 'info');
                
                // 生成6位访问码
                const accessCode = generateAccessCode();
                
                // 创建仓库
                const repoData = await createGitHubRepo(token, repoName, accessCode);
                
                if (repoData.id) {
                    // 保存访问码与仓库ID的映射 (实际应用中应存储在安全的地方)
                    await saveAccessCodeMapping(token, repoData.full_name, accessCode);
                    
                    // 显示结果
                    document.getElementById('storage-id').textContent = repoData.full_name;
                    document.getElementById('access-code').textContent = accessCode;
                    document.getElementById('create-result').classList.remove('hidden');
                    
                    // 自动切换到文件操作
                    currentStorage = repoData.full_name;
                    currentToken = token;
                    showFileOperation();
                    loadFileList();
                    
                    showMessage('存储创建成功', 'success');
                }
            } catch (error) {
                console.error('创建存储失败:', error);
                showMessage('创建失败: ' + (error.message || '未知错误'), 'error');
            }
        });
        
        // 使用6位码访问
        document.getElementById('access-with-code').addEventListener('click', async () => {
            const code = document.getElementById('short-code').value.trim();
            
            if (!code || code.length !== 6) {
                showMessage('请输入有效的6位访问码', 'error');
                return;
            }
            
            try {
                showMessage('正在验证访问码...', 'info');
                
                // 获取访问码对应的仓库信息
                const { repoFullName, token } = await getRepoFromAccessCode(code);
                
                if (repoFullName && token) {
                    currentStorage = repoFullName;
                    currentToken = token;
                    showFileOperation();
                    loadFileList();
                    showMessage('访问成功', 'success');
                } else {
                    showMessage('无效的访问码', 'error');
                }
            } catch (error) {
                console.error('访问失败:', error);
                showMessage('访问失败: ' + (error.message || '未知错误'), 'error');
            }
        });
        
        // 使用完整信息访问
        document.getElementById('access-with-full').addEventListener('click', async () => {
            const storageId = document.getElementById('full-storage-id').value.trim();
            const token = document.getElementById('access-token').value.trim();
            
            if (!storageId || !token) {
                showMessage('请填写所有字段', 'error');
                return;
            }
            
            try {
                showMessage('正在验证信息...', 'info');
                
                // 验证仓库是否存在
                const repoExists = await verifyGitHubRepo(token, storageId);
                
                if (repoExists) {
                    currentStorage = storageId;
                    currentToken = token;
                    showFileOperation();
                    loadFileList();
                    showMessage('访问成功', 'success');
                } else {
                    showMessage('存储ID或令牌无效', 'error');
                }
            } catch (error) {
                console.error('访问失败:', error);
                showMessage('访问失败: ' + (error.message || '未知错误'), 'error');
            }
        });
        
        // 显示文件操作区域
        function showFileOperation() {
            createSection.classList.add('hidden');
            accessSection.classList.add('hidden');
            fileOperation.classList.remove('hidden');
            document.getElementById('storage-info').textContent = currentStorage;
        }
        
        // 生成6位访问码
        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // 创建GitHub仓库
        async function createGitHubRepo(token, repoName, accessCode) {
            // 为了解决令牌过早失效问题，我们使用正确的API调用方式
            // 并确保只请求必要的权限
            const response = await fetch('https://api.github.com/user/repos', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: repoName,
                    private: true, // 私有仓库更安全
                    description: `File storage with access code: ${accessCode}`,
                    auto_init: true
                }),
                // 增加超时设置，适应需要加速器的网络环境
                signal: AbortSignal.timeout(30000)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        }
        
        // 验证GitHub仓库是否存在
        async function verifyGitHubRepo(token, repoFullName) {
            const response = await fetch(`https://api.github.com/repos/${repoFullName}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                },
                signal: AbortSignal.timeout(30000)
            });
            
            return response.ok;
        }
        
        // 保存访问码与仓库的映射
        async function saveAccessCodeMapping(token, repoFullName, accessCode) {
            // 在实际应用中，这里应该将映射关系存储在一个专门的仓库中
            // 为简化起见，我们将信息存储在当前仓库的一个特殊文件中
            const content = JSON.stringify({
                repo: repoFullName,
                code: accessCode,
                token: token, // 实际应用中不应存储令牌，这里仅为演示
                created: new Date().toISOString()
            });
            
            const encodedContent = btoa(unescape(encodeURIComponent(content)));
            
            await fetch(`https://api.github.com/repos/${repoFullName}/contents/.access-info`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Save access information',
                    content: encodedContent
                }),
                signal: AbortSignal.timeout(30000)
            });
        }
        
        // 通过访问码获取仓库信息
        async function getRepoFromAccessCode(code) {
            // 注意：这是一个简化实现
            // 实际应用中，应该有一个中央存储来映射访问码和仓库信息
            
            // 这里假设我们有一个已知的仓库用于存储映射关系
            // 实际使用时需要修改为您自己的映射仓库
            const mappingRepo = 'your-username/access-mappings';
            const mappingToken = 'your-mapping-repo-token'; // 只读权限即可
            
            try {
                // 获取所有可能的映射文件
                const response = await fetch(`https://api.github.com/repos/${mappingRepo}/contents/`, {
                    headers: {
                        'Authorization': `token ${mappingToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: AbortSignal.timeout(30000)
                });
                
                if (!response.ok) {
                    throw new Error(`无法访问映射仓库: ${response.status}`);
                }
                
                const files = await response.json();
                
                // 查找匹配的访问码
                for (const file of files) {
                    const fileResponse = await fetch(file.download_url, {
                        signal: AbortSignal.timeout(10000)
                    });
                    
                    if (fileResponse.ok) {
                        const content = await fileResponse.json();
                        if (content.code === code) {
                            return {
                                repoFullName: content.repo,
                                token: content.token
                            };
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('获取仓库信息失败:', error);
                throw error;
            }
        }
        
        // 加载文件列表
        async function loadFileList() {
            try {
                const response = await fetch(`https://api.github.com/repos/${currentStorage}/contents/`, {
                    headers: {
                        'Authorization': `token ${currentToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: AbortSignal.timeout(30000)
                });
                
                if (!response.ok) {
                    throw new Error(`无法加载文件列表: ${response.status}`);
                }
                
                const files = await response.json();
                const fileListEl = document.getElementById('file-list');
                fileListEl.innerHTML = '';
                
                // 过滤掉特殊文件
                const userFiles = files.filter(file => file.name !== '.access-info' && file.name !== 'README.md');
                
                if (userFiles.length === 0) {
                    fileListEl.innerHTML = '<div class="p-4 text-center text-gray-500">存储中没有文件</div>';
                    return;
                }
                
                userFiles.forEach(file => {
                    if (file.type === 'file') {
                        const fileEl = document.createElement('div');
                        fileEl.className = 'p-3 flex justify-between items-center hover:bg-gray-50';
                        fileEl.innerHTML = `
                            <div class="flex items-center">
                                <i class="fa fa-file-o text-primary mr-2"></i>
                                <span>${file.name}</span>
                            </div>
                            <button class="text-primary hover:text-primary/80 download-btn" 
                                    data-url="${file.download_url}">
                                <i class="fa fa-download"></i>
                            </button>
                        `;
                        fileListEl.appendChild(fileEl);
                        
                        // 添加下载事件
                        fileEl.querySelector('.download-btn').addEventListener('click', async (e) => {
                            const url = e.target.dataset.url || e.target.parentElement.dataset.url;
                            await downloadFile(url);
                        });
                    }
                });
            } catch (error) {
                console.error('加载文件列表失败:', error);
                showMessage('加载文件失败: ' + (error.message || '未知错误'), 'error');
            }
        }
        
        // 上传文件
        async function uploadFiles(files) {
            const progressEl = document.getElementById('upload-progress');
            const statusEl = document.getElementById('upload-status');
            
            progressEl.classList.remove('hidden');
            statusEl.classList.remove('hidden');
            progressEl.style.width = '0%';
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    statusEl.textContent = `正在上传: ${file.name} (${i+1}/${files.length})`;
                    
                    // 读取文件内容
                    const content = await readFileAsBase64(file);
                    
                    // 上传到GitHub
                    const response = await fetch(`https://api.github.com/repos/${currentStorage}/contents/${file.name}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${currentToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Upload file: ${file.name}`,
                            content: content
                        }),
                        signal: AbortSignal.timeout(60000) // 上传大文件超时时间更长
                    });
                    
                    if (!response.ok) {
                        throw new Error(`上传失败: ${response.status}`);
                    }
                    
                    // 更新进度
                    progressEl.style.width = `${((i + 1) / files.length) * 100}%`;
                }
                
                statusEl.textContent = '所有文件上传成功!';
                showMessage('文件上传成功', 'success');
                
                // 重新加载文件列表
                setTimeout(loadFileList, 1000);
                
                // 重置上传控件
                document.getElementById('file-upload').value = '';
                
                // 3秒后隐藏进度条
                setTimeout(() => {
                    progressEl.classList.add('hidden');
                    statusEl.classList.add('hidden');
                    progressEl.style.width = '0%';
                }, 3000);
            } catch (error) {
                console.error('文件上传失败:', error);
                statusEl.textContent = `上传失败: ${error.message}`;
                statusEl.classList.add('text-danger');
                showMessage('文件上传失败: ' + (error.message || '未知错误'), 'error');
            }
        }
        
        // 读取文件为Base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // 提取Base64内容（去掉dataURL前缀）
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // 下载文件
        async function downloadFile(url) {
            try {
                showMessage('正在准备下载...', 'info');
                
                // 使用令牌进行授权下载
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${currentToken}`
                    },
                    signal: AbortSignal.timeout(60000)
                });
                
                if (!response.ok) {
                    throw new Error(`下载失败: ${response.status}`);
                }
                
                const blob = await response.blob();
                const fileName = url.split('/').pop();
                
                // 创建下载链接
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                
                showMessage('文件下载成功', 'success');
            } catch (error) {
                console.error('文件下载失败:', error);
                showMessage('文件下载失败: ' + (error.message || '未知错误'), 'error');
            }
        }
        
        // 显示消息提示
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            
            // 设置样式
            messageEl.className = 'fixed bottom-4 right-4 p-4 rounded-md shadow-lg transform transition-all duration-300 max-w-xs';
            
            switch (type) {
                case 'success':
                    messageEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                    break;
                case 'error':
                    messageEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                    break;
                default:
                    messageEl.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
            }
            
            // 显示消息
            messageEl.classList.remove('translate-y-20', 'opacity-0');
            
            // 3秒后隐藏
            setTimeout(() => {
                messageEl.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 为6位码输入框添加自动大写转换
            document.getElementById('short-code').addEventListener('input', function(e) {
                this.value = this.value.toUpperCase();
            });
        });
    </script>
</body>
</html>
