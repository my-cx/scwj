<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件传输工具（调试版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        dark: '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .card {
                @apply bg-white rounded-lg shadow shadow-md p-6 transition-all hover:shadow-lg;
            }
            .debug-log {
                @apply text-xs text-gray-500 mt-2 p-2 bg-gray-50 rounded;
                max-height: 150px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-dark mb-2">
                <i class="fa fa-github mr-2"></i>文件传输输工具（调试试版）
            </h1>
            <p class="text-secondary text-lg">带详细调试信息的版本，用于排查6位代码访问问题</p>
        </header>

        <!-- 模式选择器 -->
        <div class="card mb-8">
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="mode-create" class="btn-primary flex-1">
                    <i class="fa fa-plus-circle mr-2"></i>创建新存储
                </button>
                <button id="mode-access" class="btn-secondary flex-1">
                    <i class="fa fa-key mr-2"></i>访问现有存储
                </button>
            </div>
        </div>

        <!-- 创建新存储 -->
        <div id="create-section" class="card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-plus-circle text-primary mr-2"></i>创建新存储
            </h2>
            
            <div class="mb-4 p-3 bg-blue-50 border border border-blue-200 rounded text-sm text-blue-700">
                <i class="fa fa-info-circle mr-1"></i>
                <strong>调试提示：</strong>创建时的操作会被记录在下方日志中
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="github-token">GitHub 令牌</label>
                <input 
                    type="password" 
                    id="github-token" 
                    class="w-full px-3 py-2 border border border-gray-300 rounded-md input-focus"
                    placeholder="输入你的GitHub令牌（仅需输入一次）"
                >
                <p class="text-xs text-gray-500 mt-1">需要具备repo权限的个人访问令牌</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="repo-name">存储仓库名</label>
                <input 
                    type="text" 
                    id="repo-name" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                    placeholder="例如：my-file-storage-001"
                >
                <p id="repo-name-hint" class="text-xs mt-1 hidden"></p>
            </div>
            
            <button id="create-storage" class="btn-primary w-full">
                <i class="fa fa-check mr-2"></i>创建存储
            </button>
            
            <div id="create-result" class="mt-4 hidden">
                <div class="p-3 bg-green-100 border border border-green-400 rounded text-green-700">
                    <h3 class="font-medium-medium mb-1">存储创建成功！</h3>
                    <p>存储ID: <span id="storage-id" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
                    <p>访问代码: <span id="access-code" class="font-mono bg-gray-200 px-2 py-1 rounded text-lg font-bold"></span></p>
                    <p class="text-sm mt-2">在其他设备上，仅需输入这个6位代码即可访问</p>
                </div>
            </div>
            
            <div id="create-debug-log" class="debug-log hidden">
                <strong>调试创建日志：</strong>
                <div id="create-log-content"></div>
            </div>
        </div>

        <!-- 访问现有存储 -->
        <div id="access-section" class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-key text-primary mr-2"></i>访问存储
            </h2>
            
            <div class="mb-4 p-3 bg-blue-50 border border border-blue-200 rounded text-sm text-blue-700">
                <i class="fa fa-info-circle mr-1"></i>
                <strong>调试提示：</strong>请输入6位代码并观察下方日志信息
            </div>
            
            <div class="mb-4">
                <div class="flex items-center mb-1">
                    <label class="block text-sm font-medium text-gray-700">访问方式</label>
                </div>
                <div class="flex gap-2">
                    <button id="access-code-btn" class="btn-primary flex-1">6位访问码（推荐）</button>
                    <button id="full-id-btn" class="btn-secondary flex-1">完整存储ID</button>
                </div>
            </div>
            
            <!-- 6位访问码方式（无需输入令牌） -->
            <div id="code-access" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="short-code">6位访问码</label>
                    <input 
                        type="text" 
                        id="short-code" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus text-center text-xl"
                        placeholder="输入6位代码（无需令牌）"
                        maxlength="6"
                    >
                </div>
                
                <!-- 调试信息配置 -->
                <div class="p-3 bg-gray-50 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-1">GitHub用户名（用于定位映射仓库）</label>
                    <input 
                        type="text" 
                        id="github-username" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus text-sm"
                        placeholder="输入你的GitHub用户名"
                    >
                    <p class="text-xs text-gray-500 mt-1">必填项，用于查找你的映射仓库</p>
                </div>
                
                <button id="access-with-code" class="btn-primary w-full">
                    <i class="fa fa-unlock mr-2"></i>使用访问码访问
                </button>
            </div>
            
            <!-- 完整ID方式 -->
            <div id="full-access" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="full-storage-id">存储ID</label>
                    <input 
                        type="text" 
                        id="full-storage-id" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                        placeholder="输入完整存储ID（格式：用户名/仓库名）"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="access-token">访问令牌</label>
                    <input 
                        type="password" 
                        id="access-token" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                        placeholder="输入令牌"
                    >
                </div>
                
                <button id="access-with-full" class="btn-primary w-full">
                    <i class="fa fa-unlock-alt mr-2"></i>使用完整信息访问
                </button>
            </div>
            
            <!-- 调试日志 -->
            <div id="access-debug-log" class="debug-log hidden">
                <strong>访问日志：</strong>
                <div id="access-log-content"></div>
            </div>
        </div>

        <!-- 文件操作区域 -->
        <div id="file-operation" class="card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-folder-open text-primary mr-2"></i>存储内容
                <span id="storage-info" class="ml-2 text-sm text-gray-500"></span>
            </h2>
            
            <div class="mb-6">
                <button id="upload-btn" class="btn-secondary mb-4">
                    <i class="fa fa-upload mr-2"></i>上传文件
                </button>
                <input type="file" id="file-upload" class="hidden" multiple>
                
                <div class="relative">
                    <div id="upload-progress" class="hidden absolute top-0 left-0 h-full bg-primary/20 rounded-md transition-all" style="width: 0%"></div>
                    <div id="upload-status" class="hidden text-center py-2 relative z-10"></div>
                </div>
            </div>
            
            <div class="mb-4">
                <h3 class="font-medium mb-2">文件列表</h3>
                <div id="file-list" class="border rounded-md max-h-60 overflow-y-auto divide-y">
                    <div class="p-4 text-center text-gray-500">
                        连接后将显示文件列表
                    </div>
                </div>
            </div>
        </div>

        <!-- 消息提示 -->
        <div id="message" class="fixed bottom-4 right-4 p-4 rounded-md shadow-lg-lg transform transition-all duration-300 translate-y-20 opacity-0 max-w-xs"></div>
    </div>

    <script>
        // DOM元素
        const modeCreateBtn = document.getElementById('mode-create');
        const modeAccessBtn = document.getElementById('mode-access');
        const createSection = document.getElementById('create-section');
        const accessSection = document.getElementById('access-section');
        const fileOperation = document.getElementById('file-operation');
        const accessCodeBtn = document.getElementById('access-code-btn');
        const fullIdBtn = document.getElementById('full-id-btn');
        const codeAccess = document.getElementById('code-access');
        const fullAccess = document.getElementById('full-access');
        const repoNameInput = document.getElementById('repo-name');
        const repoNameHint = document.getElementById('repo-name-hint');
        const githubUsernameInput = document.getElementById('github-username');
        
        // 调试日志元素
        const createDebugLog = document.getElementById('create-debug-log');
        const createLogContent = document.getElementById('create-log-content');
        const accessDebugLog = document.getElementById('access-debug-log');
        const accessLogContent = document.getElementById('access-log-content');
        
        // 状态变量
        let currentStorage = null;
        let currentToken = null;
        
        // 仓库名验证正则
        const repoNameRegex = /^[a-zA-Z0-9_\-.]{1,100}$/;
        const invalidCharsRegex = /[^a-zA-Z0-9_\-.]/g;
        
        // 添加调试日志
        function addCreateLog(message) {
            createDebugLog.classList.remove('hidden');
            const timestamp = new Date().toLocaleTimeString();
            createLogContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            createLogContent.scrollTop = createLogContent.scrollHeight;
        }
        
        function addAccessLog(message) {
            accessDebugLog.classList.remove('hidden');
            const timestamp = new Date().toLocaleTimeString();
            accessLogContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            accessLogContent.scrollTop = accessLogContent.scrollHeight;
        }
        
        // 监听仓库名输入，实时验证
        repoNameInput.addEventListener('input', () => {
            const value = repoNameInput.value;
            
            if (value.length === 0) {
                repoNameHint.classList.add('hidden');
                return;
            }
            
            if (value.length > 100) {
                showRepoHint(`仓库名过长（最多100个字符），当前${value.length}个字符`, 'error');
                return;
            }
            
            const invalidChars = value.match(invalidCharsRegex);
            if (invalidChars) {
                showRepoHint(`包含无效字符：${[...new Set(invalidChars)].join('、')}`, 'error');
                return;
            }
            
            if (value.startsWith('-') || value.endsWith('-')) {
                showRepoHint('仓库名不能以连字符开头或结尾', 'error');
                return;
            }
            
            showRepoHint('仓库名格式有效', 'success');
        });
        
        function showRepoHint(text, type = 'info') {
            repoNameHint.textContent = text;
            repoNameHint.classList.remove('hidden', 'text-red-500', 'text-green-500');
            
            if (type === 'error') {
                repoNameHint.classList.add('text-red-500');
            } else {
                repoNameHint.classList.add('text-green-500');
            }
        }
        
        // 模式切换
        modeCreateBtn.addEventListener('click', () => {
            createSection.classList.remove('hidden');
            accessSection.classList.add('hidden');
            fileOperation.classList.add('hidden');
            modeCreateBtn.classList.remove('btn-secondary');
            modeCreateBtn.classList.add('btn-primary');
            modeAccessBtn.classList.remove('btn-primary');
            modeAccessBtn.classList.add('btn-secondary');
        });
        
        modeAccessBtn.addEventListener('click', () => {
            createSection.classList.add('hidden');
            accessSection.classList.remove('hidden');
            fileOperation.classList.add('hidden');
            modeCreateBtn.classList.remove('btn-primary');
            modeCreateBtn.classList.add('btn-secondary');
            modeAccessBtn.classList.remove('btn-secondary');
            modeAccessBtn.classList.add('btn-primary');
        });
        
        // 访问方式切换
        accessCodeBtn.addEventListener('click', () => {
            codeAccess.classList.remove('hidden');
            fullAccess.classList.add('hidden');
            accessCodeBtn.classList.remove('btn-secondary');
            accessCodeBtn.classList.add('btn-primary');
            fullIdBtn.classList.remove('btn-primary');
            fullIdBtn.classList.add('btn-secondary');
        });
        
        fullIdBtn.addEventListener('click', () => {
            codeAccess.classList.add('hidden');
            fullAccess.classList.remove('hidden');
            accessCodeBtn.classList.remove('btn-primary');
            accessCodeBtn.classList.add('btn-secondary');
            fullIdBtn.classList.remove('btn-secondary');
            fullIdBtn.classList.add('btn-primary');
        });
        
        // 上传按钮点击事件
        document.getElementById('upload-btn').addEventListener('click', () => {
            document.getElementById('file-upload').click();
        });
        
        // 文件选择处理
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length > 0 && currentStorage && currentToken) {
                await uploadFiles(files);
            }
        });
        
        // 创建存储
        document.getElementById('create-storage').addEventListener('click', async () => {
            // 清空之前的日志
            createLogContent.innerHTML = '';
            addCreateLog('开始创建存储流程...');
            
            const token = document.getElementById('github-token').value.trim();
            const repoName = document.getElementById('repo-name').value.trim();
            
            if (!token) {
                addCreateLog('错误：未输入GitHub令牌');
                showMessage('请输入GitHub令牌（仅需一次）', 'error');
                return;
            }
            
            if (!repoName) {
                addCreateLog('错误：未输入仓库名');
                showMessage('请输入仓库名', 'error');
                return;
            }
            
            if (!repoNameRegex.test(repoName) || repoName.startsWith('-') || repoName.endsWith('-')) {
                addCreateLog(`错误：仓库名格式无效 - ${repoName}`);
                showMessage('仓库名格式无效，请检查提示信息', 'error');
                return;
            }
            
            try {
                addCreateLog('正在检查仓库名是否可用...');
                showMessage('正在检查仓库名是否可用...', 'info');
                
                // 获取用户名并检查仓库是否存在
                addCreateLog('尝试获取GitHubHub用户名...');
                const username = await getGitHubUsername(token);
                addCreateLog(`成功功获取用户名：${username}`);
                
                const repoFullName = `${username}/${repoName}`;
                addCreateLog(`检查仓库是否存在：${repoFullName}`);
                
                const repoExists = await verifyGitHubRepo(token, repoFullName);
                
                if (repoExists) {
                    addCreateLog('错误：仓库名已存在');
                    showMessage('仓库名已存在，请更换一个名称', 'error');
                    return;
                }
                
                addCreateLog('仓库名可用，开始创建存储...');
                showMessage('正在创建存储...', 'info');
                
                // 生成6位访问码
                const accessCode = generateAccessCode();
                addCreateLog(`生成6位访问码：${accessCode}`);
                
                // 创建仓库
                addCreateLog(`开始创建仓库：${repoName}`);
                const repoData = await createGitHubRepo(token, repoName, accessCode);
                
                if (repoData.id) {
                    addCreateLog(`仓库创建成功：${repoData.full_name} (ID: ${repoData.id})`);
                    
                    // 保存访问码、仓库ID和令牌的映射关系
                    addCreateLog('开始保存访问码映射关系...');
                    await saveAccessCodeMapping(token, repoData.full_name, accessCode);
                    addCreateLog('访问码映射关系保存成功');
                    
                    // 显示结果
                    document.getElementById('storage-id').textContent = repoData.full_name;
                    document.getElementById('access-code').textContent = accessCode;
                    document.getElementById('create-result').classList.remove('hidden');
                    
                    // 自动切换到文件操作
                    currentStorage = repoData.full_name;
                    currentToken = token;
                    showFileOperation();
                    loadFileList();
                    
                    addCreateLog('存储创建流程完成');
                    showMessage('存储创建成功！其他设备仅需输入6位代码即可访问', 'success');
                }
            } catch (error) {
                console.error('创建存储失败:', error);
                addCreateLog(`创建失败: ${error.message || '未知错误'}`);
                
                let errorMsg = '创建失败: ';
                if (error.message.includes('401')) {
                    errorMsg += '令牌无效或没有权限，请检查令牌';
                } else if (error.message.includes('422')) {
                    errorMsg += '仓库名不符合符合要求或已存在';
                } else if (error.message.includes('timeout')) {
                    errorMsg += '连接超时，请检查网络或加速器';
                } else {
                    errorMsg += error.message || '未知错误';
                }
                
                showMessage(errorMsg, 'error');
            }
        });
        
        // 获取GitHub用户名
        async function getGitHubUsername(token) {
            try {
                addCreateLog('调用GitHubHub API API API获取用户信息...');
                return fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `tokenen ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    signal: AbortSignal.timeout(15000)
                })
                .then(response => {
                    addCreateLog(`GitHub API响应状态：${response.status}`);
                    if (!response.ok) {
                        throw new Error(`获取取用户信息失败: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(userData => {
                    addCreateLog(`成功解析用户信息，用户名：${userData.login}`);
                    return userData.login;
                });
            } catch (error) {
                addCreateLog(`获取用户名失败: ${error.message}`);
                throw error;
            }
        }
        
        // 使用6位码访问（无需手动输入令牌）
        document.getElementById('access-with-code').addEventListener('click', async () => {
            // 清空之前的日志
            accessLogContent.innerHTML = '';
            addAccessLog('开始6位代码访问流程...');
            
            const code = document.getElementById('short-code').value.trim().toUpperCase();
            const username = document.getElementById('github-username').value.trim();
            
            if (!username) {
                addAccessLog('错误：未输入GitHub用户名');
                showMessage('请输入你的GitHub用户名（用于定位映射仓库）', 'error');
                return;
            }
            
            if (!code || code.length !== 6) {
                addAccessLog(`错误：无效的6位代码 - ${code}`);
                showMessage('请输入有效的6位访问码', 'error');
                return;
            }
            
            try {
                addAccessLog(`验证6位代码：${code}，用户名为：${username}`);
                showMessage('正在验证访问码...', 'info');
                
                // 通过6位代码获取仓库信息和令牌
                addAccessLog('尝试通过6位代码获取仓库信息...');
                const { repoFullName, token } = await getRepoFromAccessCode(code, username);
                
                if (repoFullName && token) {
                    addAccessLog(`成功功获取仓库信息：${repoFullName}`);
                    currentStorage = repoFullName;
                    currentToken = token;
                    showFileOperation();
                    loadFileList();
                    addAccessLog('6位代码访问流程完成，访问成功');
                    showMessage('访问成功！', 'success');
                } else {
                    addAccessLog('错误：未找到有效的仓库信息');
                    showMessage('无效的访问码', 'error');
                }
            } catch (error) {
                console.error('访问失败:', error);
                addAccessLog(`访问失败: ${error.message || '未知错误'}`);
                
                let errorMsg = '访问失败: ';
                if (error.message.includes('404')) {
                    errorMsg += '未找到到访问码对应的存储，请检查代码和用户名是否正确';
                } else if (error.message.includes('403')) {
                    errorMsg += '没有访问权限，映射仓库可能是私有的';
                } else if (error.message.includes('timeout')) {
                    errorMsg += '连接超时，请检查网络或加速器';
                } else {
                    errorMsg += error.message || '未知错误';
                }
                
                showMessage(errorMsg, 'error');
            }
        });
        
        // 使用完整信息访问
        document.getElementById('access-with-full').addEventListener('click', async () => {
            const storageId = document.getElementById('full-storage-id').value.trim();
            const token = document.getElementById('access-token').value.trim();
            
            if (!storageId || !token) {
                showMessage('请填写所有字段', 'error');
                return;
            }
            
            if (!storageId.includes('/')) {
                showMessage('存储ID格式应为：用户名/仓库名', 'error');
                return;
            }
            
            try {
                showMessage('正在验证信息...', 'info');
                
                const repoExists = await verifyGitHubRepo(token, storageId);
                
                if (repoExists) {
                    currentStorage = storageId;
                    currentToken = token;
                    showFileOperation();
                    loadFileList();
                    showMessage('访问成功', 'success');
                } else {
                    showMessage('存储ID或令牌无效', 'error');
                }
            } catch (error) {
                console.error('访问失败:', error);
                showMessage('访问失败: ' + (error.message || '未知错误'), 'error');
            }
        });
        
        // 显示文件操作区域
        function showFileOperation() {
            createSection.classList.add('hidden');
            accessSection.classList.add('hidden');
            fileOperation.classList.remove('hidden');
            document.getElementById('storage-info').textContent = currentStorage;
        }
        
        // 生成6位访问码
        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAts.charAtAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // 创建GitHub仓库
        async function createGitHubRepo(token, repoName, accessCode) {
            return fetch('https://api.github.com/user/repos', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: repoName,
                    private: true,
                    description: `File storage with access code: ${accessCode}`,
                    auto_init: true
                }),
                signal: AbortSignal.timeout(30000)
            })
            .then(response => {
                addCreateLog(`创建仓库API响应状态：${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                }
                return response.json();
            });
        }
        
        // 验证GitHub仓库是否存在
        async function verifyGitHubRepo(token, repoFullName) {
            return fetchch(`https://api.github.com/repos/${repoFullName}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd/vnd.github.v3+json'
                },
