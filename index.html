<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件传输工具（安全版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded transition-all;
            }
            .card {
                @apply bg-white rounded-lg shadow-md p-6 transition-all hover:shadow-lg;
            }
            .debug-log {
                @apply text-xs text-gray-700 mt-2 p-3 bg-gray-50 rounded border border-gray-200;
                max-height: 200px;
                overflow-y: auto;
            }
            .alert {
                @apply p-3 rounded my-4 text-sm border;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
                <i class="fa fa-github mr-2"></i>文件传输工具
            </h1>
            <p class="text-gray-600">安全版 - 解决敏感信息检测问题</p>
        </header>

        <!-- 安全提示 -->
        <div class="alert bg-green-50 border-green-200 text-green-800 mb-6">
            <i class="fa fa-shield mr-2"></i>
            <strong>安全改进：</strong>本版本不再在映射文件中存储令牌，解决了GitHub的敏感信息检测问题。
            访问时需要手动输入您的GitHub令牌。
        </div>

        <!-- 模式选择器 -->
        <div class="card mb-6">
            <div class="flex flex-col md:flex-row gap-3">
                <button id="mode-create" class="btn-primary flex-1">
                    <i class="fa fa-plus-circle mr-2"></i>创建存储
                </button>
                <button id="mode-access" class="btn-secondary flex-1">
                    <i class="fa fa-key mr-2"></i>访问存储
                </button>
            </div>
        </div>

        <!-- 创建存储区域 -->
        <div id="create-section" class="card mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">创建新存储</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="github-token">GitHub 令牌</label>
                <input 
                    type="password" 
                    id="github-token" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                    placeholder="输入你的GitHub令牌（需要repo权限）"
                >
                <p class="text-xs text-gray-500 mt-1">
                    令牌将用于创建仓库，不会被存储在任何公开位置
                </p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="repo-name">存储仓库名</label>
                <input 
                    type="text" 
                    id="repo-name" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                    placeholder="例如：my-files-2023"
                >
            </div>
            
            <button id="create-storage" class="btn-primary w-full mb-4">
                <i class="fa fa-check mr-2"></i>创建存储并生成访问码
            </button>
            
            <div id="create-result" class="mt-4 hidden">
                <div class="p-3 bg-green-100 border border-green-300 rounded text-green-800">
                    <h3 class="font-medium mb-1">创建成功！</h3>
                    <p>存储ID: <span id="storage-id" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
                    <p>6位访问码: <span id="access-code" class="font-mono bg-gray-200 px-2 py-1 rounded text-lg font-bold"></span></p>
                    <p class="text-xs mt-2">
                        <i class="fa fa-info-circle mr-1"></i>请保存好访问码，用于后续访问
                    </p>
                </div>
            </div>
            
            <div class="debug-log hidden" id="create-log">
                <strong class="text-gray-800">创建过程日志：</strong>
                <div id="create-log-content"></div>
            </div>
        </div>

        <!-- 访问存储区域 -->
        <div id="access-section" class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">访问存储</h2>
            
            <div class="mb-4">
                <div class="flex gap-2 mb-2">
                    <button id="access-code-btn" class="btn-primary flex-1">6位访问码访问</button>
                    <button id="full-id-btn" class="btn-secondary flex-1">完整ID访问</button>
                </div>
            </div>
            
            <!-- 6位访问码访问 -->
            <div id="code-access" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="short-code">6位访问码</label>
                    <input 
                        type="text" 
                        id="short-code" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus text-center text-xl"
                        placeholder="输入6位代码"
                        maxlength="6"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="github-username">GitHub用户名</label>
                    <input 
                        type="text" 
                        id="github-username" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                        placeholder="你的GitHub账号名"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="access-user-token">你的GitHub令牌</label>
                    <input 
                        type="password" 
                        id="access-user-token" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                        placeholder="用于访问的GitHub令牌"
                    >
                    <p class="text-xs text-gray-500 mt-1">
                        仅用于本次访问，不会被存储
                    </p>
                </div>
                
                <div class="flex gap-2">
                    <button id="access-with-code" class="btn-primary flex-1">
                        <i class="fa fa-unlock mr-2"></i>访问存储
                    </button>
                    <button id="check-mapping" class="btn-secondary flex-1">
                        <i class="fa fa-search mr-2"></i>检查映射
                    </button>
                </div>
            </div>
            
            <!-- 完整ID访问 -->
            <div id="full-access" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="full-storage-id">存储ID (用户名/仓库名)</label>
                    <input 
                        type="text" 
                        id="full-storage-id" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="full-access-token">GitHub令牌</label>
                    <input 
                        type="password" 
                        id="full-access-token" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus"
                    >
                </div>
                
                <button id="access-with-full" class="btn-primary w-full">
                    <i class="fa fa-unlock-alt mr-2"></i>访问存储
                </button>
            </div>
            
            <div class="debug-log hidden" id="access-log">
                <strong class="text-gray-800">访问过程日志：</strong>
                <div id="access-log-content"></div>
            </div>
        </div>

        <!-- 文件操作区域 -->
        <div id="file-operation" class="card mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                存储内容: <span id="storage-info" class="text-sm font-normal text-gray-600"></span>
            </h2>
            
            <div class="mb-4">
                <button id="upload-btn" class="btn-secondary mb-3">
                    <i class="fa fa-upload mr-2"></i>上传文件
                </button>
                <input type="file" id="file-upload" class="hidden" multiple>
                
                <div class="relative h-8">
                    <div id="upload-progress" class="hidden absolute top-0 left-0 h-full bg-primary/20 rounded-md transition-all" style="width: 0%"></div>
                    <div id="upload-status" class="hidden absolute top-0 left-0 w-full h-full flex items-center justify-center text-sm"></div>
                </div>
            </div>
            
            <div>
                <h3 class="font-medium mb-2 text-gray-700">文件列表</h3>
                <div id="file-list" class="border rounded-md max-h-60 overflow-y-auto divide-y">
                    <div class="p-4 text-center text-gray-500">
                        连接成功后将显示文件列表
                    </div>
                </div>
            </div>
        </div>

        <!-- 消息提示 -->
        <div id="message" class="fixed bottom-4 right-4 p-4 rounded-md shadow-lg transform transition-all duration-300 translate-y-20 opacity-0 max-w-xs z-10"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const modeCreateBtn = document.getElementById('mode-create');
            const modeAccessBtn = document.getElementById('mode-access');
            const createSection = document.getElementById('create-section');
            const accessSection = document.getElementById('access-section');
            const fileOperation = document.getElementById('file-operation');
            const accessCodeBtn = document.getElementById('access-code-btn');
            const fullIdBtn = document.getElementById('full-id-btn');
            const codeAccess = document.getElementById('code-access');
            const fullAccess = document.getElementById('full-access');
            const accessWithCodeBtn = document.getElementById('access-with-code');
            const checkMappingBtn = document.getElementById('check-mapping');
            
            // 状态变量
            let currentStorage = null;
            let currentToken = null;
            
            // 日志函数
            function addCreateLog(message) {
                const logEl = document.getElementById('create-log');
                const contentEl = document.getElementById('create-log-content');
                logEl.classList.remove('hidden');
                const timestamp = new Date().toLocaleTimeString();
                contentEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                contentEl.scrollTop = contentEl.scrollHeight;
            }
            
            function addAccessLog(message) {
                const logEl = document.getElementById('access-log');
                const contentEl = document.getElementById('access-log-content');
                logEl.classList.remove('hidden');
                const timestamp = new Date().toLocaleTimeString();
                contentEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                contentEl.scrollTop = contentEl.scrollHeight;
            }
            
            // 显示消息
            function showMessage(text, type = 'info') {
                const messageEl = document.getElementById('message');
                messageEl.textContent = text;
                
                messageEl.className = 'fixed bottom-4 right-4 p-4 rounded-md shadow-lg transform transition-all duration-300 max-w-xs z-10';
                
                switch (type) {
                    case 'success':
                        messageEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                        break;
                    case 'error':
                        messageEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                        break;
                    case 'warning':
                        messageEl.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
                        break;
                    default:
                        messageEl.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
                }
                
                messageEl.classList.remove('translate-y-20', 'opacity-0');
                
                setTimeout(() => {
                    messageEl.classList.add('translate-y-20', 'opacity-0');
                }, 5000);
            }
            
            // 模式切换
            modeCreateBtn.addEventListener('click', () => {
                createSection.classList.remove('hidden');
                accessSection.classList.add('hidden');
                fileOperation.classList.add('hidden');
                modeCreateBtn.classList.remove('btn-secondary');
                modeCreateBtn.classList.add('btn-primary');
                modeAccessBtn.classList.remove('btn-primary');
                modeAccessBtn.classList.add('btn-secondary');
            });
            
            modeAccessBtn.addEventListener('click', () => {
                createSection.classList.add('hidden');
                accessSection.classList.remove('hidden');
                fileOperation.classList.add('hidden');
                modeCreateBtn.classList.remove('btn-primary');
                modeCreateBtn.classList.add('btn-secondary');
                modeAccessBtn.classList.remove('btn-secondary');
                modeAccessBtn.classList.add('btn-primary');
            });
            
            // 访问方式切换
            accessCodeBtn.addEventListener('click', () => {
                codeAccess.classList.remove('hidden');
                fullAccess.classList.add('hidden');
                accessCodeBtn.classList.remove('btn-secondary');
                accessCodeBtn.classList.add('btn-primary');
                fullIdBtn.classList.remove('btn-primary');
                fullIdBtn.classList.add('btn-secondary');
            });
            
            fullIdBtn.addEventListener('click', () => {
                codeAccess.classList.add('hidden');
                fullAccess.classList.remove('hidden');
                accessCodeBtn.classList.remove('btn-primary');
                accessCodeBtn.classList.add('btn-secondary');
                fullIdBtn.classList.remove('btn-secondary');
                fullIdBtn.classList.add('btn-primary');
            });
            
            // 创建存储
            document.getElementById('create-storage').addEventListener('click', async function() {
                // 清空日志和结果
                document.getElementById('create-log-content').innerHTML = '';
                document.getElementById('create-result').classList.add('hidden');
                
                try {
                    const token = document.getElementById('github-token').value.trim();
                    const repoName = document.getElementById('repo-name').value.trim();
                    
                    if (!token) {
                        addCreateLog('错误：未输入GitHub令牌');
                        showMessage('请输入GitHub令牌', 'error');
                        return;
                    }
                    
                    if (!repoName) {
                        addCreateLog('错误：未输入仓库名');
                        showMessage('请输入存储仓库名', 'error');
                        return;
                    }
                    
                    addCreateLog('开始创建存储流程...');
                    showMessage('开始创建存储...', 'info');
                    
                    // 1. 获取用户名
                    addCreateLog('步骤1：获取GitHub用户名');
                    const username = await getGitHubUsername(token);
                    addCreateLog(`成功获取用户名：${username}`);
                    
                    // 2. 检查仓库是否存在
                    const repoFullName = `${username}/${repoName}`;
                    addCreateLog(`步骤2：检查仓库是否存在 - ${repoFullName}`);
                    
                    const repoExists = await verifyGitHubRepo(token, repoFullName);
                    if (repoExists) {
                        addCreateLog('错误：仓库已存在');
                        showMessage('仓库名已存在，请更换一个名称', 'error');
                        return;
                    }
                    
                    // 3. 生成6位访问码
                    const accessCode = generateAccessCode();
                    addCreateLog(`步骤3：生成6位访问码 - ${accessCode}`);
                    
                    // 4. 创建存储仓库（公开）
                    addCreateLog(`步骤4：创建存储仓库（公开） - ${repoName}`);
                    const repoData = await createGitHubRepo(token, repoName, accessCode, false);
                    addCreateLog(`仓库创建成功：${repoData.full_name} (ID: ${repoData.id})`);
                    
                    // 5. 创建/验证映射仓库（公开）
                    addCreateLog('步骤5：处理映射仓库（公开）...');
                    const mappingRepo = `${username}/access-mappings`;
                    let mappingRepoExists = await verifyGitHubRepo(token, mappingRepo);
                    
                    if (!mappingRepoExists) {
                        addCreateLog(`映射仓库不存在，创建映射仓库：${mappingRepo}`);
                        await createGitHubRepo(token, 'access-mappings', '用于存储访问码映射关系', false);
                        
                        // 验证映射仓库是否创建成功
                        mappingRepoExists = await verifyGitHubRepo(token, mappingRepo);
                        if (!mappingRepoExists) {
                            throw new Error('映射仓库创建失败，请手动创建 access-mappings 仓库并设为公开');
                        }
                        addCreateLog('映射仓库创建成功');
                    } else {
                        addCreateLog(`映射仓库已存在：${mappingRepo}`);
                    }
                    
                    // 6. 保存访问码映射（不包含令牌！）
                    addCreateLog(`步骤6：保存访问码映射 - ${accessCode}.json`);
                    await saveAccessCodeMapping(token, repoData.full_name, accessCode);
                    addCreateLog('访问码映射保存完成');
                    
                    // 7. 验证映射是否成功创建
                    addCreateLog('步骤7：验证映射关系...');
                    await verifyMappingExists(token, mappingRepo, accessCode);
                    addCreateLog('映射关系验证成功');
                    
                    // 显示结果
                    document.getElementById('storage-id').textContent = repoData.full_name;
                    document.getElementById('access-code').textContent = accessCode;
                    document.getElementById('create-result').classList.remove('hidden');
                    
                    // 切换到文件操作
                    currentStorage = repoData.full_name;
                    currentToken = token;
                    showFileOperation();
                    loadFileList();
                    
                    addCreateLog('存储创建流程完成');
                    showMessage('存储创建成功！访问码已保存', 'success');
                } catch (error) {
                    console.error('创建失败:', error);
                    addCreateLog(`创建失败: ${error.message}`);
                    
                    let errorMsg = '创建失败: ' + error.message;
                    if (error.message.includes('409')) {
                        errorMsg += '，可能是仓库命名冲突或安全规则限制';
                    } else if (error.message.includes('映射仓库')) {
                        errorMsg += '，请手动创建并设置为公开';
                    }
                    
                    showMessage(errorMsg, 'error');
                }
            });
            
            // 检查映射关系
            checkMappingBtn.addEventListener('click', async function() {
                addAccessLog('开始检查映射关系...');
                showMessage('正在检查映射关系...', 'info');
                
                try {
                    const code = document.getElementById('short-code').value.trim().toUpperCase();
                    const username = document.getElementById('github-username').value.trim();
                    
                    if (!username) {
                        addAccessLog('错误：未输入GitHub用户名');
                        showMessage('请输入你的GitHub用户名', 'error');
                        return;
                    }
                    
                    if (!code || code.length !== 6) {
                        addAccessLog(`错误：无效的6位代码 (${code})`);
                        showMessage('请输入有效的6位访问码', 'error');
                        return;
                    }
                    
                    const mappingRepo = `${username}/access-mappings`;
                    addAccessLog(`检查映射仓库：${mappingRepo}`);
                    
                    // 1. 检查映射仓库是否存在
                    const repoExists = await checkPublicRepoExists(mappingRepo);
                    if (!repoExists) {
                        addAccessLog(`错误：映射仓库不存在 - ${mappingRepo}`);
                        showMessage(`未找到映射仓库 ${mappingRepo}，请先创建存储`, 'error');
                        return;
                    }
                    addAccessLog(`映射仓库存在：${mappingRepo}`);
                    
                    // 2. 检查访问码文件是否存在
                    addAccessLog(`检查访问码文件：${code}.json`);
                    const fileExists = await checkMappingFileExists(mappingRepo, code);
                    
                    if (fileExists) {
                        addAccessLog(`访问码文件存在：${code}.json`);
                        showMessage('映射关系验证成功，可以访问存储', 'success');
                    } else {
                        addAccessLog(`错误：未找到访问码文件 - ${code}.json`);
                        showMessage(`在映射仓库中未找到 ${code}.json 文件，请重新创建存储`, 'error');
                    }
                } catch (error) {
                    addAccessLog(`检查失败: ${error.message}`);
                    showMessage('检查映射失败: ' + error.message, 'error');
                }
            });
            
            // 使用6位访问码访问
            accessWithCodeBtn.addEventListener('click', async function() {
                document.getElementById('access-log-content').innerHTML = '';
                addAccessLog('开始6位访问码访问流程...');
                
                try {
                    const code = document.getElementById('short-code').value.trim().toUpperCase();
                    const username = document.getElementById('github-username').value.trim();
                    const userToken = document.getElementById('access-user-token').value.trim();
                    
                    if (!username) {
                        addAccessLog('错误：未输入GitHub用户名');
                        showMessage('请输入你的GitHub用户名', 'error');
                        return;
                    }
                    
                    if (!code || code.length !== 6) {
                        addAccessLog(`错误：无效的6位代码 (${code})`);
                        showMessage('请输入有效的6位访问码', 'error');
                        return;
                    }
                    
                    if (!userToken) {
                        addAccessLog('错误：未输入GitHub令牌');
                        showMessage('请输入你的GitHub令牌', 'error');
                        return;
                    }
                    
                    showMessage('正在验证访问码...', 'info');
                    
                    // 1. 检查映射仓库是否存在（公开可访问）
                    const mappingRepo = `${username}/access-mappings`;
                    addAccessLog(`步骤1：检查映射仓库 ${mappingRepo}`);
                    
                    const repoExists = await checkPublicRepoExists(mappingRepo);
                    if (!repoExists) {
                        throw new Error(`映射仓库不存在，请确认用户名正确：${mappingRepo}`);
                    }
                    
                    // 2. 检查访问码文件是否存在
                    addAccessLog(`步骤2：检查访问码文件 ${code}.json`);
                    const fileExists = await checkMappingFileExists(mappingRepo, code);
                    
                    if (!fileExists) {
                        throw new Error(`未找到访问码对应的文件：${code}.json`);
                    }
                    
                    // 3. 获取映射信息（不包含令牌）
                    addAccessLog(`步骤3：获取映射信息`);
                    const { repoFullName } = await getRepoFromAccessCode(code, username);
                    
                    if (repoFullName) {
                        addAccessLog(`成功获取仓库信息：${repoFullName}`);
                        
                        // 验证用户提供的令牌是否有效
                        addAccessLog(`步骤4：验证令牌有效性`);
                        const tokenValid = await verifyGitHubRepo(userToken, repoFullName);
                        
                        if (!tokenValid) {
                            throw new Error('令牌无效或没有访问该仓库的权限');
                        }
                        
                        currentStorage = repoFullName;
                        currentToken = userToken;
                        showFileOperation();
                        loadFileList();
                        
                        addAccessLog('访问成功');
                        showMessage('访问成功！', 'success');
                    } else {
                        throw new Error('未找到有效的仓库信息');
                    }
                } catch (error) {
                    console.error('访问失败:', error);
                    addAccessLog(`访问失败: ${error.message}`);
                    
                    let errorMsg = '访问失败: ' + error.message;
                    if (error.message.includes('403')) {
                        errorMsg += '，可能是因为映射仓库是私有的，请将其设为公开';
                    }
                    
                    showMessage(errorMsg, 'error');
                }
            });
            
            // 使用完整ID访问
            document.getElementById('access-with-full').addEventListener('click', async function() {
                const storageId = document.getElementById('full-storage-id').value.trim();
                const token = document.getElementById('full-access-token').value.trim();
                
                if (!storageId || !token) {
                    showMessage('请填写所有字段', 'error');
                    return;
                }
                
                if (!storageId.includes('/')) {
                    showMessage('存储ID格式应为：用户名/仓库名', 'error');
                    return;
                }
                
                try {
                    const repoExists = await verifyGitHubRepo(token, storageId);
                    
                    if (repoExists) {
                        currentStorage = storageId;
                        currentToken = token;
                        showFileOperation();
                        loadFileList();
                        showMessage('访问成功', 'success');
                    } else {
                        showMessage('存储ID或令牌无效', 'error');
                    }
                } catch (error) {
                    showMessage('访问失败: ' + error.message, 'error');
                }
            });
            
            // 上传文件相关
            document.getElementById('upload-btn').addEventListener('click', () => {
                document.getElementById('file-upload').click();
            });
            
            document.getElementById('file-upload').addEventListener('change', async (e) => {
                const files = e.target.files;
                if (files.length > 0 && currentStorage && currentToken) {
                    await uploadFiles(files);
                }
            });
            
            // 辅助函数
            function showFileOperation() {
                createSection.classList.add('hidden');
                accessSection.classList.add('hidden');
                fileOperation.classList.remove('hidden');
                document.getElementById('storage-info').textContent = currentStorage;
            }
            
            function generateAccessCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            }
            
            // 检查仓库可见性
            async function checkRepoVisibility(token, repoFullName) {
                const response = await fetch(`https://api.github.com/repos/${repoFullName}`, {
                    headers: { 'Authorization': `token ${token}` },
                    signal: AbortSignal.timeout(15000)
                });
                
                if (!response.ok) {
                    throw new Error(`无法检查仓库可见性 (${response.status})`);
                }
                
                const repoData = await response.json();
                return !repoData.private; // private为false表示公开
            }
            
            // GitHub API相关函数
            async function getGitHubUsername(token) {
                const response = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${token}` },
                    signal: AbortSignal.timeout(15000)
                });
                
                if (!response.ok) {
                    throw new Error(`获取用户信息失败 (${response.status})`);
                }
                
                const userData = await response.json();
                return userData.login;
            }
            
            async function verifyGitHubRepo(token, repoFullName) {
                const response = await fetch(`https://api.github.com/repos/${repoFullName}`, {
                    headers: { 'Authorization': `token ${token}` },
                    signal: AbortSignal.timeout(15000)
                });
                
                return response.ok;
            }
            
            // 检查公共仓库是否存在（无需令牌）
            async function checkPublicRepoExists(repoFullName) {
                const response = await fetch(`https://api.github.com/repos/${repoFullName}`, {
                    signal: AbortSignal.timeout(15000)
                });
                
                return response.ok;
            }
            
            // 创建GitHub仓库（公开）
            async function createGitHubRepo(token, repoName, description, isPrivate = false) {
                const response = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: repoName,
                        private: isPrivate, // 公开仓库
                        description: description,
                        auto_init: true
                    }),
                    signal: AbortSignal.timeout(30000)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`创建仓库失败 (${response.status}): ${errorData.message || '未知错误'}`);
                }
                
                return response.json();
            }
            
            // 保存访问码映射（不包含令牌！）
            async function saveAccessCodeMapping(token, repoFullName, accessCode) {
                const [username] = repoFullName.split('/');
                const mappingRepo = `${username}/access-mappings`;
                
                // 映射内容中不再包含令牌！
                const content = JSON.stringify({
                    repo: repoFullName,
                    created: new Date().toISOString()
                });
                
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                const response = await fetch(`https://api.github.com/repos/${mappingRepo}/contents/${accessCode}.json`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add access code ${accessCode}`,
                        content: encodedContent
                    }),
                    signal: AbortSignal.timeout(30000)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`保存映射失败 (${response.status}): ${errorData.message || '未知错误'}`);
                }
            }
            
            async function verifyMappingExists(token, mappingRepo, accessCode) {
                const response = await fetch(`https://api.github.com/repos/${mappingRepo}/contents/${accessCode}.json`, {
                    headers: { 'Authorization': `token ${token}` },
                    signal: AbortSignal.timeout(15000)
                });
                
                if (!response.ok) {
                    throw new Error(`映射文件创建失败 (${response.status})`);
                }
            }
            
            async function checkMappingFileExists(mappingRepo, accessCode) {
                const response = await fetch(`https://api.github.com/repos/${mappingRepo}/contents/${accessCode}.json`, {
                    signal: AbortSignal.timeout(15000)
                });
                
                return response.ok;
            }
            
            // 获取映射信息（不包含令牌）
            async function getRepoFromAccessCode(code, username) {
                const mappingRepo = `${username}/access-mappings`;
                
                const response = await fetch(`https://api.github.com/repos/${mappingRepo}/contents/${code}.json`, {
                    headers: { 'Accept': 'application/vnd.github.v3+json' },
                    signal: AbortSignal.timeout(15000)
                });
                
                if (!response.ok) {
                    throw new Error(`访问映射仓库失败 (${response.status})，可能是仓库未公开`);
                }
                
                const fileData = await response.json();
                const content = JSON.parse(atob(fileData.content));
                
                // 只返回仓库信息，不包含令牌
                return {
                    repoFullName: content.repo
                };
            }
            
            // 文件列表加载
            async function loadFileList() {
                try {
                    const response = await fetch(`https://api.github.com/repos/${currentStorage}/contents/`, {
                        headers: { 'Authorization': `token ${currentToken}` },
                        signal: AbortSignal.timeout(30000)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`加载文件列表失败 (${response.status})`);
                    }
                    
                    const files = await response.json();
                    const fileListEl = document.getElementById('file-list');
                    fileListEl.innerHTML = '';
                    
                    const userFiles = files.filter(file => 
                        !file.name.endsWith('.json') && 
                        file.name !== 'README.md' && 
                        file.type === 'file'
                    );
                    
                    if (userFiles.length === 0) {
                        fileListEl.innerHTML = '<div class="p-4 text-center text-gray-500">存储中没有文件</div>';
                        return;
                    }
                    
                    userFiles.forEach(file => {
                        const fileEl = document.createElement('div');
                        fileEl.className = 'p-3 flex justify-between items-center hover:bg-gray-50';
                        fileEl.innerHTML = `
                            <div class="flex items-center">
                                <i class="fa fa-file-o text-primary mr-2"></i>
                                <span>${file.name}</span>
                            </div>
                            <button class="text-primary hover:text-primary/80 download-btn" 
                                    data-url="${file.download_url}">
                                <i class="fa fa-download"></i>
                            </button>
                        `;
                        fileListEl.appendChild(fileEl);
                        
                        fileEl.querySelector('.download-btn').addEventListener('click', async (e) => {
                            const url = e.target.dataset.url || e.target.parentElement.dataset.url;
                            await downloadFile(url);
                        });
                    });
                } catch (error) {
                    showMessage('加载文件失败: ' + error.message, 'error');
                }
            }
            
            // 文件上传
            async function uploadFiles(files) {
                const progressEl = document.getElementById('upload-progress');
                const statusEl = document.getElementById('upload-status');
                
                progressEl.classList.remove('hidden');
                statusEl.classList.remove('hidden');
                progressEl.style.width = '0%';
                
                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        statusEl.textContent = `正在上传: ${file.name} (${i+1}/${files.length})`;
                        
                        const content = await readFileAsBase64(file);
                        
                        const response = await fetch(`https://api.github.com/repos/${currentStorage}/contents/${file.name}`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `token ${currentToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Upload ${file.name}`,
                                content: content
                            }),
                            signal: AbortSignal.timeout(60000)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`上传 ${file.name} 失败 (${response.status})`);
                        }
                        
                        progressEl.style.width = `${((i + 1) / files.length) * 100}%`;
                    }
                    
                    statusEl.textContent = '所有文件上传成功!';
                    showMessage('文件上传成功', 'success');
                    setTimeout(loadFileList, 1000);
                    
                    setTimeout(() => {
                        progressEl.classList.add('hidden');
                        statusEl.classList.add('hidden');
                        progressEl.style.width = '0%';
                    }, 3000);
                } catch (error) {
                    statusEl.textContent = `上传失败: ${error.message}`;
                    statusEl.classList.add('text-danger');
                    showMessage('文件上传失败: ' + error.message, 'error');
                }
            }
            
            // 文件转Base64
            function readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // 文件下载
            async function downloadFile(url) {
                try {
                    showMessage('正在准备下载...', 'info');
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `token ${currentToken}` },
                        signal: AbortSignal.timeout(60000)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`下载失败 (${response.status})`);
                    }
                    
                    const blob = await response.blob();
                    const fileName = url.split('/').pop();
                    
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showMessage('文件下载成功', 'success');
                } catch (error) {
                    showMessage('下载失败: ' + error.message, 'error');
                }
            }
            
            // 初始化完成
            console.log('安全版初始化完成，已移除敏感信息存储');
            showMessage('安全版已加载，访问时请输入你的GitHub令牌', 'info');
        });
    </script>
</body>
</html>
