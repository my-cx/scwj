<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简文件托管</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">文件托管</h1>
        
        <!-- 认证区域 -->
        <div class="mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">GitHub 令牌</label>
                <input type="text" id="token" class="w-full p-2 border border-gray-300 rounded" 
                       placeholder="输入包含gist权限的令牌">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Gist ID</label>
                <div class="flex">
                    <input type="text" id="gistId" class="flex-1 p-2 border border-gray-300 rounded-l" 
                           placeholder="Gist ID">
                    <button id="createGist" class="bg-green-500 text-white p-2 rounded-r">新建</button>
                </div>
            </div>
            
            <button id="connect" class="w-full bg-blue-500 text-white p-2 rounded mb-2">连接</button>
            <div id="status" class="text-sm text-gray-500 text-center hidden"></div>
        </div>
        
        <!-- 上传区域 -->
        <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded p-4 text-center mb-6 hidden">
            <p class="mb-2">拖放文件到这里或点击选择</p>
            <label class="bg-blue-500 text-white p-2 rounded inline-block cursor-pointer">
                选择文件
                <input type="file" id="fileInput" class="hidden" multiple>
            </label>
        </div>
        
        <!-- 文件列表 -->
        <div id="filesArea" class="hidden">
            <h2 class="font-bold mb-2">文件列表</h2>
            <div id="loading" class="text-center py-4 hidden">
                <i class="fa fa-spinner fa-spin"></i> 加载中...
            </div>
            <div id="filesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div id="noFiles" class="text-center py-4 text-gray-500 hidden">暂无文件</div>
        </div>
    </div>

    <script>
        // 元素
        const tokenInput = document.getElementById('token');
        const gistIdInput = document.getElementById('gistId');
        const createGistBtn = document.getElementById('createGist');
        const connectBtn = document.getElementById('connect');
        const statusEl = document.getElementById('status');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const filesArea = document.getElementById('filesArea');
        const loadingEl = document.getElementById('loading');
        const filesList = document.getElementById('filesList');
        const noFilesEl = document.getElementById('noFiles');
        
        // 变量
        let token, gistId;
        
        // 事件监听
        createGistBtn.addEventListener('click', createGist);
        connectBtn.addEventListener('click', connect);
        fileInput.addEventListener('change', handleFiles);
        
        // 拖放支持
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-blue-500');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-blue-500');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-blue-500');
            if (e.dataTransfer.files.length) {
                handleFiles({ target: { files: e.dataTransfer.files } });
            }
        });
        
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // 显示状态消息
        function showStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
            statusEl.classList.add(isError ? 'text-red-600' : 'text-green-600');
        }
        
        // 创建新Gist
        async function createGist() {
            token = tokenInput.value.trim();
            if (!token) {
                showStatus('请先输入GitHub令牌', true);
                return;
            }
            
            try {
                showStatus('正在创建Gist...');
                const response = await axios.post('https://api.github.com/gists', {
                    description: '文件存储',
                    public: false,
                    files: { 'info.txt': { content: '文件存储根目录' } }
                }, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                gistIdInput.value = response.data.id;
                showStatus('Gist创建成功！');
            } catch (error) {
                console.error('创建Gist错误:', error);
                showStatus(`创建失败: ${getErrorMsg(error)}`, true);
            }
        }
        
        // 连接并加载文件
        async function connect() {
            token = tokenInput.value.trim();
            gistId = gistIdInput.value.trim();
            
            if (!token) {
                showStatus('请输入GitHub令牌', true);
                return;
            }
            
            if (!gistId) {
                showStatus('请输入Gist ID或点击新建', true);
                return;
            }
            
            try {
                showStatus('正在连接...');
                uploadArea.classList.remove('hidden');
                filesArea.classList.remove('hidden');
                loadFiles();
            } catch (error) {
                showStatus(`连接失败: ${getErrorMsg(error)}`, true);
            }
        }
        
        // 加载文件列表
        async function loadFiles() {
            if (!token || !gistId) return;
            
            loadingEl.classList.remove('hidden');
            noFilesEl.classList.add('hidden');
            filesList.innerHTML = '';
            
            try {
                const response = await axios.get(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                const files = response.data.files;
                const fileNames = Object.keys(files).filter(name => name !== 'info.txt');
                
                if (fileNames.length === 0) {
                    noFilesEl.classList.remove('hidden');
                } else {
                    fileNames.forEach(name => {
                        const file = files[name];
                        const size = formatSize(file.content.length * 0.75); // 估算实际大小
                        
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-2 border rounded';
                        div.innerHTML = `
                            <div>
                                <div>${name}</div>
                                <div class="text-xs text-gray-500">${size}</div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="download bg-green-100 p-1 rounded" data-name="${name}" data-url="${file.content}">
                                    <i class="fa fa-download"></i>
                                </button>
                                <button class="delete bg-red-100 p-1 rounded" data-name="${name}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        `;
                        filesList.appendChild(div);
                    });
                    
                    // 添加下载和删除事件
                    document.querySelectorAll('.download').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const a = document.createElement('a');
                            a.href = e.target.closest('.download').dataset.url;
                            a.download = e.target.closest('.download').dataset.name;
                            a.click();
                        });
                    });
                    
                    document.querySelectorAll('.delete').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            if (confirm(`确定删除 ${e.target.closest('.delete').dataset.name}?`)) {
                                deleteFile(e.target.closest('.delete').dataset.name);
                            }
                        });
                    });
                }
                
                showStatus('连接成功');
            } catch (error) {
                console.error('加载文件错误:', error);
                showStatus(`加载失败: ${getErrorMsg(error)}`, true);
                noFilesEl.classList.remove('hidden');
            } finally {
                loadingEl.classList.add('hidden');
            }
        }
        
        // 处理文件上传
        function handleFiles(e) {
            Array.from(e.target.files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showStatus('文件不能超过10MB', true);
                    return;
                }
                uploadFile(file);
            });
        }
        
        // 上传文件
        async function uploadFile(file) {
            try {
                showStatus(`正在上传 ${file.name}...`);
                
                // 读取文件
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = async () => {
                    // 获取当前Gist
                    const gist = await axios.get(`https://api.github.com/gists/${gistId}`, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    
                    // 准备更新
                    const files = { ...gist.data.files };
                    files[file.name] = { content: reader.result };
                    
                    // 更新Gist
                    await axios.patch(`https://api.github.com/gists/${gistId}`, { files }, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    
                    showStatus(`上传 ${file.name} 成功`);
                    loadFiles(); // 重新加载列表
                };
            } catch (error) {
                console.error('上传错误:', error);
                showStatus(`上传失败: ${getErrorMsg(error)}`, true);
            }
        }
        
        // 删除文件
        async function deleteFile(filename) {
            try {
                showStatus(`正在删除 ${filename}...`);
                
                // 获取当前Gist
                const gist = await axios.get(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                // 准备更新（设置为null表示删除）
                const files = { ...gist.data.files };
                files[filename] = null;
                
                // 更新Gist
                await axios.patch(`https://api.github.com/gists/${gistId}`, { files }, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                showStatus(`删除 ${filename} 成功`);
                loadFiles(); // 重新加载列表
            } catch (error) {
                console.error('删除错误:', error);
                showStatus(`删除失败: ${getErrorMsg(error)}`, true);
            }
        }
        
        // 辅助函数：格式化文件大小
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // 辅助函数：提取错误信息
        function getErrorMsg(error) {
            if (error.response) {
                if (error.response.status === 401) return '令牌无效或没有权限';
                if (error.response.status === 404) return 'Gist ID不存在';
                return `HTTP错误 ${error.response.status}`;
            }
            return error.message || '未知错误';
        }
    </script>
</body>
</html>
